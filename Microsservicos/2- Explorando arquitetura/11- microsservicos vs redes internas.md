Bom, pessoal, no vídeo anterior a gente falou sobre o tempo de expiração. Quanto maior o tempo de expiração, menor a carga no servidor de autenticação, mas menor o controle que a gente tem sobre o usuário durante a validade do token. O que também é muito comum de acontecer é que, às vezes, a gente não tem uma API Gateway, ou às vezes, mesmo tendo uma API Gateway, a gente não quer fazer a validação desse token na API Gateway. A gente pode fazer a autenticação no próprio microsserviço. Isso significa que essa chave pública aqui, que está na API Gateway, que foi gerada pelo servidor de autenticação, pode ficar disponível em cada microsserviço. Ou seja, toda vez que a gente receber uma requisição, a requisição vai bater no seu microsserviço, o seu microsserviço vai valida essa chave, vai validar o JWT usando essa chave, se estiver “ok”, ele processa a requisição, se não estiver “ok”, ele não processa a requisição. Ele fala ali que o cara não está autorizado. Qual é o problema disso aqui? É que o seu microsserviço, vai começar a receber requisições que o cara não tem autenticação, por exemplo, mas mesmo assim ele vai ter que tratar esse tráfego. 

Imagina um monte de gente, mandando um monte de requisição não autorizada. O seu microsserviço vai ter que ficar negando essa requisição o tempo todo. Então, isso aqui, de fato, não é legal. Aqui você vai ter que decidir que, ou o seu microsserviço valida realmente todo o JWT para ver se ele é válido ou não, ou se ele acredita, por padrão, que todo o JWT que chegar aqui para ele vai ser válido porque em algum momento ele passou aqui pela API Gateway. Ou seja, você acredita em todos os dados que vão chegar dentro da sua rede interna porque você parte do princípio que tudo que chegou aqui é válido por conta que essa validação bateu na API Gateway. Tem algum problema em acreditar nessa situação? Absolutamente nenhum problema. Principalmente, se esses seus microsserviços não estiverem expostos pela internet. O que você vai fazer aqui nesse caso para você conseguir garantir isso? O que você vai fazer é o seguinte, na hora que você configura esses microsserviços aqui, eu vou criar mais uma separação aqui, e deixa eu colocar esse background aqui separado. Vou colocar esse cara aqui desse jeito, e vou tentar jogar esse cara aqui para trás, (ficou bem mais ou menos). O que significa que essa… tudo que está rodando aqui os nossos microsserviços, nesse caso o servidor de identidade tem que estar para fora disso porque o usuário vai ter acesso público nele para fazer o login. Vamos dizer que o servidor de identidade pode estar aqui, ou ele pode estar entre esses microsserviços e outro. Só para você saber o que acontece. Isso aqui é uma subnet sem acesso à internet. Significa que ninguém da internet vai conseguir ter acesso a esses microsserviços. Todo mundo vai poder ter acesso a esses microsserviços somente se ele bater na API Gateway. A API Gateway tem acesso à internet, ou seja, o usuário final bate na API Gateway, mas quando a API Gateway manda a requisição para os microsserviços, toda essa requisição a gente sabe que a única forma do dado chegar aqui é através da API Gateway, então, eu não tenho que me preocupar. A forma de você garantir um pouco mais de segurança e não ficar com medo de um usuário externo ficar tentando acessar seu microsserviço é jogar o seu microsserviço numa rede fora da internet, ou seja, sem ingresso direto, sem uma internet gateway para que as pessoas consigam acessar, mas quem tem acesso a esses microsserviços é a sua API Gateway porque ela consegue falar nessa rede. Ela faz parte de uma outra subnet, é essa aqui ele faz parte de uma subnet pública, mas essa subnet consegue acessar essa subnet aqui, então, você não vai ficar com medinho no final do dia de que o usuário final consiga bater diretamente no seu microsserviço, o seu microsserviço fica escondido dentro de uma rede onde você não vai ter mais esse tipo de medo.

Essa abordagem aqui que eu acabei de falar para vocês é super válida. É super comum de ser utilizada e eu não acho, na minha opinião, que você tem que ficar com medo de não colocar autenticação nos seus microsserviços e acreditar aqui em tudo que está chegando. Se você quiser, você pode até validar esse JWT de alguma forma, não tem problema, mas o que eu estou querendo dizer é que você não precisa, porque se você trabalhou dessa forma como eu coloquei aqui, os seus microsserviços estão protegidos e você pode acreditar nas requisições que vem de fora, porque você sabe que a única forma delas chegarem aqui é através das… passando pela API Gateway e acreditando que a API Gateway está validando todas as suas requisições. Então, essa abordagem, se você quiser fazer uma dupla autenticação “ok”, você pega a chave pública e coloca também nos microsserviços. Qual é o problema de colocar as chaves públicas nos seus microsserviços? O problema é o seguinte, vamos imaginar que você tem 200 microsserviços, então, você vai ter que copiar essa chave pública para esses 200 microsserviços. Se por algum motivo você mudar essa chave pública, você vai ter que mudar essa chave pública nesses 200 microsserviços, então, você vai ter que fazer o redeploy ali dessas chaves públicas.

Então, quanto menos esforço você tiver para lidar com a autenticação é melhor. Então, pense sempre nesse approach. No próximo vídeo, eu vou fazer um resumo sobre o que a gente falou, baseado nessas observações que eu acabei de colocar aqui. Vamos nessa!