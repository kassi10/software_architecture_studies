Bom, pessoal, eu falei bastante sobre como a comunicação assíncrona ajuda a gente a economizar recursos computacionais, e agora eu quero mostrar aqui para vocês o comportamento disso ali na prática, mostrando a gente consumindo uma carga de trabalho e verificando quanto tempo isso demora para ser processado. E assim a gente consegue ver o poder da comunicação assíncrona para que você consiga utilizar no dia a dia.

Como funciona essa dinâmica aqui? Eu tenho uma aplicação, depois eu vou deixar o endereço para vocês. Para você trabalhar, poder trabalhar com comunicação assíncrona. Ela foi feita pelo meu amigo Gago, Luiz Carlos Faria. Um cara bem forte na comunidade de .NET, e ele criou esse exemplo aqui para que você, de uma forma um pouco mais clara, consiga ver a possibilidade de você trabalhar de forma assíncrona. O que fica por trás de tudo isso? É uma aplicação que está rodando, ele desenvolveu com C#. Nós temos o RabbitMQ, a gente vai falar um pouco dele depois, nós temos também o Grafana, onde a gente consegue ver dashboards e a gente tem também o Postgresql como banco de dados onde ele guarda as informações a serem consumidas. Como funciona isso aqui? O negócio é o seguinte: vamos imaginar que eu tenho uma certa carga de trabalho que tem que ser processada por uma unidade de processamento. Então, o que acontece? Olha só que interessante, vamos imaginar que eu tenho, por exemplo, 10 sistemas mandando requisição para a minha aplicação, mas a minha aplicação não tem capacidade de processar 10 pessoas ao mesmo tempo. Essas 10 pessoas ao mesmo tempo vão mandar aqui para a gente 10 mensagens por segundo, então, significa que eu vou ter 100 mensagens por segundo para ser processada. Então, eu vou adicionar uma carga de trabalho aqui, que vai nos trazer 10 máquinas produzindo 10 mensagens por segundo aqui para mim. Logo, eu tenho 10 máquinas mandando 10 mensagens por segundo. Agora o grande ponto é o seguinte, eu não tenho ninguém consumindo essas mensagens, então, se eu tivesse trabalhando de forma síncrona eu estaria perdendo todas essas mensagens, porque eu tenho o sistema fora do ar. Olha só, a cada segundo eu estaria perdendo 100 mensagens, 1 milhão de reais por mensagem a gente estaria perdendo 100 milhões de reais por segundo. Olha só como isso é importante. Como eu consigo ver isso na prática? Se eu olhar aqui, eu tenho o Grafana. O Grafana é um sistema que nos mostra informações em tempo real do que está acontecendo com o nosso sistema. Então, se você olhar aqui, ele vai trazer para a gente o tamanho da fila, ou seja, o tamanho da quantidade de mensagens que foi chegando, e ao invés de a gente perder essas mensagens, essa mensagem ficou guardada ali numa fila, num local onde essas mensagens não são perdidas. Se você olhar aqui para a gente, você vai perceber que eu já tenho aqui 7.412 mensagens nesse momento que estão paradas para algum sistema consumir. Se, nesse momento, eu tivesse trabalhado de forma síncrona, eu estaria, querendo ou não, perdendo ali quase 10 mil mensagens.

Agora, como essas mensagens estão enfileiradas, simplesmente, eu não vou perder essas mensagens e agora eu vou querer começar a consumir essas mensagens. O que acontece aqui? Se você olhar, nesse gráfico verde, eu tenho a minha capacidade de publicação, ou seja, eu estou conseguindo publicar 100% das minhas mensagens, mas eu não estou consumindo nenhuma mensagem. Então, agora, o que eu vou fazer? Eu vou pegar aqui e colocar que eu tenho 5 máquinas, 5 instâncias, capazes de processar 10 mensagens por segundo. Então, eu vou adicionar aqui esses caras, vamos aguardar um pouquinho, porque o meu sistema, querendo ou não, ele fica mais sobrecarregado, porque ele está processando, mandando tudo isso de mensagem, e eu estou gravando vídeo. E agora sim, então, eu tenho 100 mensagens sendo enviadas por segundo e eu tenho 50 mensagens por segundo sendo consumidas. Nesse momento, se eu for olhar aqui o meu Grafana, a gente já vai ver que tem uma situação um pouco diferente. Por quê? Porque nós temos agora um processamento das nossas mensagens, está vendo? Então, agora a coisa  está mudando um pouco de figura. Por quê? Porque simplesmente nós podemos pegar essas mensagens. Agora, se você começar a perceber, eu estou conseguindo consumir isso de mensagens e eu tenho agora essa possibilidade de publicação de mensagens, ou seja, eu estou consumindo menos mensagem do que eu estou publicando, mas pelo menos eu estou conseguindo consumir. Você vai perceber que, de forma geral, o tamanho dessa fila só vai começar a subir. Por quê? Porque simplesmente eu estou consumindo menos mensagem do que eu estou publicando.

Agora a gente vai fazer uma mudança. Eu vou adicionar que eu consigo consumir 200 mensagens por segundo em uma outra instância. Então, eu vou adicionar agora aqui, e a gente vai perceber agora que eu tenho a capacidade de ler, de consumir 250 mensagens por segundo, enquanto eu tenho a capacidade de produzir 100 mensagens por segundo. Assim, agora a coisa muda de figura. Por quê? Porque agora eu consigo consumir mais, ou seja, 250 mensagens, enquanto eu só publico 100 mensagens aqui para mim. Você vai perceber que o tamanho da minha fila agora vai tender a diminuir. Porque eu consigo consumir mais mensagens do que eu começo a publicar. 

O mais interessante de tudo isso é que, baseado nessas estatísticas aqui, eu tenho um tempo médio de processamento. O que significa? Que até “tantos” segundos eu consegui publicar, processar as minhas mensagens. Então, isso aqui mostra para a gente, sabe aquela história que eu falei para vocês da fila do banco? Eu consigo ver ali para mim o quanto de tempo as pessoas que estão na fila vão poder ser atendidas. E, baseado nisso, eu vou ver se para mim compensa ou não colocar mais atendentes. Quanto mais atendente eu coloco, mais gente eu consigo resolver o problema. E menos tempo essas pessoas vão ter que esperar. Mas quanto mais atendentes eu coloco, mais eu vou gastar. Então, o que isso significa? Significa que eu como empresa, principalmente em relação à decisão de negócio, vou decidir o quanto eu vou gastar, o quanto eu tenho de orçamento, e eu vou tentar balancear a satisfação do meu cliente com o custo que eu vou ter que colocar. E isso, no final do dia, vale para uma fila de atendimento ali no chequinho do aeroporto, mas também vale para o processamento das cargas de trabalho que os seus sistemas vão fazer.

Vamos imaginar que eu acabei de fazer uma compra no seu e-commerce. E eu faço o pagamento. Como estou trabalhando de forma assíncrona, pode ser que eu vá demorar, sei lá, um minuto para conseguir processar seu pagamento. E, assim que eu conseguir processar, eu te mando um e-mail falando que a sua compra foi aprovada. Eu não sei se você já fez uma compra, por exemplo, sei lá, numa Amazon da vida, você vai perceber que ele não fala se a sua compra foi aprovada de cara ou não. O que ele fala é ordem disso realizada… pedido realizado. Se tiver algum problema com o pagamento, ele vai receber o e-mail. Por quê? Porque eles não querem gastar para processar isso de forma síncrona. Porque eles não precisam no final das contas. Então, olha só que interessante. Aqui ele está mostrando para a gente quanto tempo ele está demorando para processar essa mensagem desde quando ela foi criada. E aqui a gente consegue ver a fila sendo diminuída cada vez mais ali para a gente.

Agora, existem algumas situações que isso provavelmente não vai ser possível. Eu vou dar um exemplo para vocês. Imagina que você vai comprar um ingresso do show do YouTube, sei lá, do Coldplay, da Katy Perry, um artista muito famoso. E eles abrem as vendas online para comprar. Tem tanta gente acessando ao mesmo tempo. Quando você comprar o ingresso, ele vai querer processar o pagamento naquele momento para você. Por quê? Porque se o seu pagamento não for aprovado, você vai saber na hora para você refazer seu pagamento, para você não perder o ingresso. Porque se ele processar só daqui um minuto, pode ser que durante esse minuto outras pessoas comprem o bendito do ingresso e você fez um pedido, e depois vai ter perdido o ingresso.

Ou a mesma coisa, uma passagem aérea. Um avião, ele tem um espaço limitado dentro da aeronave. Então, se na hora que eu comprar eu não conseguir garantir a minha passagem naquele momento, pode ser que eu perca essa oportunidade de compra. Existem casos que a comunicação assíncrona, não vai receber seu problema. Mas, por exemplo, vamos imaginar que você sente a compra do ingresso, pode ser que ele segure você ali numa fila síncrona para fazer a compra, mas depois que ele comprou, ele manda para um monte de processamento assíncrono, para gerar o bilhete, para gerar nota fiscal, para mandar o email de boas-vindas. Então, tudo isso pode ser assíncrono. E, assim, o pagamento tem que ser síncrono para ele garantir que você não compra naquele momento. Logo, para vocês perceberem como é importante vocês entenderem quando você pode utilizar uma comunicação síncrona ou assíncrona. Mas, normalmente, quando a gente está falando com o cliente final, a decisão, se vai poder ser síncrona ou assíncrona, vai ser uma decisão muito mais de negócio. Agora, quando você tem microsserviços que ficam publicando mensagens ali, tudo em background, eu recomendo que você sempre utilize comunicação assíncrona. O tamanho da fila fica, normalmente, perto de 250, porque ele vai publicando e o sistema vai lendo, e agora você vai perceber que cada vez mais o tempo de finalização de leitura de uma mensagem, até o seu processamento, começa a diminuir, porque eu tenho mais sistemas com poder computacional lendo as mensagens do que sistemas produzindo as mensagens.

Isso aqui é importante, a gente tem cinco caras, mas um deles tem 200 mensagens por segundo. Se eu coloco mais um cara com 200 mensagens por segundo, a coisa vai complicar, porque eu vou ter agora 300 mensagens sendo publicadas e 250 sendo consumidas, e agora a gente vai perceber que o tamanho da fila vai continuar só subindo, porque eu tenho menos capacidade de publicação, quer dizer, de leitura de consumo dessas mensagens. Mas se para mim estiver “ok”, tudo bem. O grande ponto é que as pessoas que vão resolver receber esse problema vão demorar mais para processar a mensagem, e dependendo da situação, está tudo bem. Então, agora basta você conseguir balancear a volumetria que você vai ter. Assim, toda vez que você pensar em comunicação assíncrona, você tem que pensar nisso que eu estou mostrando agora. E como você consegue fazer isso? Normalmente, por teste de descarga, por teste de estresse, para você ver como está o comportamento do seu sistema. Se você não tiver essas métricas, facilmente pode ser que você tenha um problema muito grande, e é por isso que ter esse tipo de informação nos sistemas, quando você trabalha de forma assíncrona, é muito facilmente. Então, é isso que eu queria ter te mostrado. Um grande abraço e até o nosso próximo vídeo.